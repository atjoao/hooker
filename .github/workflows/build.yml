name: Build hooker

permissions:
  contents: write
  
on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - arch: x64
            cxx: x86_64-w64-mingw32-clang++
            hde: hde64
            build_dir: build
            zip_name: hooker-x64
          - arch: x86
            cxx: i686-w64-mingw32-clang++
            hde: hde32
            build_dir: build-x32
            zip_name: hooker-x32
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache llvm-mingw
      uses: actions/cache@v4
      id: cache-llvm-mingw
      with:
        path: llvm-mingw-20250319-ucrt-ubuntu-20.04-x86_64
        key: llvm-mingw-20250319-ucrt-ubuntu-20.04-x86_64

    - name: Setup llvm-mingw
      if: steps.cache-llvm-mingw.outputs.cache-hit != 'true'
      run: |
        curl -L -o llvm-mingw.tar.xz "https://github.com/mstorsjo/llvm-mingw/releases/download/20250319/llvm-mingw-20250319-ucrt-ubuntu-20.04-x86_64.tar.xz"
        tar -xf llvm-mingw.tar.xz
        rm llvm-mingw.tar.xz

    - name: Add llvm-mingw to PATH
      run: echo "$PWD/llvm-mingw-20250319-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH

    - name: Build
      run: |
        mkdir -p ${{ matrix.build_dir }}
        ${{ matrix.cxx }} -O3 -static -shared -std=c++17 \
          -o ${{ matrix.build_dir }}/version.dll \
          main.cpp minhook/src/buffer.c minhook/src/hook.c minhook/src/trampoline.c minhook/src/hde/${{ matrix.hde }}.c \
          -I minhook/include -lkernel32 -luser32 version.def
        ${{ matrix.cxx }} -O3 -static -shared -std=c++17 \
          -o ${{ matrix.build_dir }}/winmm.dll \
          main.cpp minhook/src/buffer.c minhook/src/hook.c minhook/src/trampoline.c minhook/src/hde/${{ matrix.hde }}.c \
          -I minhook/include -lkernel32 -luser32 winmm.def
        ${{ matrix.cxx }} -O3 -static -shared -std=c++17 \
          -o ${{ matrix.build_dir }}/dinput8.dll \
          main.cpp minhook/src/buffer.c minhook/src/hook.c minhook/src/trampoline.c minhook/src/hde/${{ matrix.hde }}.c \
          -I minhook/include -lkernel32 -luser32 dinput8.def

    - name: Create zip
      run: |
        cd ${{ matrix.build_dir }}
        zip ../${{ matrix.zip_name }}.zip *.dll

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.zip_name }}
        path: ${{ matrix.zip_name }}.zip
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
    - name: Download x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hooker-x64
        path: ./release
        
    - name: Download x86 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hooker-x32
        path: ./release
        
    - name: Generate release info
      id: release_info
      run: |
        echo "tag=v$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        name: Hooker ${{ steps.release_info.outputs.tag }}
        body: |          
          **Build Date:** ${{ steps.release_info.outputs.date }}

          Place `dinput8.dll or version.dll or winmm.dll` (the one that the exe loads) in the same folder as your exe

          This will create a hooker.ini file in the same folder

          ```ini
          ; 0 = disabled, 1 = enabled
          [DLL]
          enable=0/1
          target=.dll     ; DLL to intercept (hooks its exports)
          replace=.dll    ; DLL with matching exports to redirect to

          [ADC]
          wintrust=0/1    ; Bypass WinVerifyTrust signature checks
          LIMIT_CORE_COUNT=-1/core_count ; Limits current process to only use x amount of cores
          IGNORE_ECORES=0/1 ; Disables use of ECORES when LIMIT_CORE_COUNT is set
          IGNORE_EXPORTS= ; Comma separated list of exports to ignore
          ```
        draft: false
        prerelease: false
        files: |
          ./release/hooker-x64.zip
          ./release/hooker-x32.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}